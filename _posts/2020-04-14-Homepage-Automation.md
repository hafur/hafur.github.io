---
layout: post
title:  "Homepage Automation Workflow"
tag: python homepage
---

My new setup is running pretty stable so far. As mentioned before, my homepage is now fully hosted on an always free compute instance on Oracle Cloud Infrastructure.
There was no downtime and I do not eperience any performace challanges. However, I am pretty certain that people from Australia will definitley experience slower performance than someone in Germany. As of now I am running the compute instance in the Frankfurt OCI Region. 
Plan is to eventally set up another compute instance (you get 2 always free instances in OCI) in another region (maybe Australia or US) and then use the [Traffic Management Steering Policies Service](https://docs.oracle.com/en-us/iaas/Content/TrafficManagement/Concepts/overview.htm) to route traffic based on the geographical region of a request - that is something for the future.

### The Issue
In this post, I want to discuss how I automated my homepage. My homepage is very simple: just a list of photos. You can click on the thumbmnail to see a larger version of the photo. The larger version displays the location of where the photo was taken.
It is plain simple static HTML code using CSS for the styling and a bit of JavaScript to enable the effect when moving over the thubmnail and also to create the overlay to view the larger version of a photo.

As plain as simple as it is - there is a major pain: whenever I want to add a new photo, I have to update the html code. It is a fairly simple update (copy and paste - literally) but nevertheless it is a very annoying process. Since the actual manual effort required is to plain simple, I thought there must be a way that _even I_ should be able to come up with a more automated soution.

### The Solution

The manual process comprises two steps:
1.  Manual upload of new photos to folder on web server via ftp
2.  Update html to include the new photos

In my mind, the automation should work like this:
1.  Upload photos to web server via ftp
2.  Html code is automatically updated

Because step 1 is actually a little bit of a security concern (I dont want to expose my web server on port 21), I came up with this final process:
1.  Upload photos to a _input_ folder via ftp
2.  A script copies the new photos to the web server
3.  Same script will also generate the new html code

Something like this:
![homepage automation](/assets/20200414/hafurflow.png)

#### The Script

The script is a mix of Python and bash code. 
The Python script manages the generation of the html code. The main work is done using the [dominate library](https://pypi.org/project/dominate/) which is a Python library for creating and manipulating HTML documents.

For example, the header part of my home page is generated by these few lines of Python code:
```
import dominate, glob, os
from dominate.tags import *

doc = dominate.document(title='hafur.com | photos of the world unite!')

with doc.head:
meta(name='Description', content='Photos of the world unite! Photos from different places in the world united on one web page.')
meta(charset='utf-8')
meta(name='viewport', content='width=device-width, initial-scale=1')
link(rel='stylesheet', href='assets/css/main.css')
.
.
.
```

The actual gallery is emmbedded in a ```section``` element using several ```div```elements. So in the manual old world, this is were I had top copy&paste some new ```div``` elements and add the proper link to the new photo.
That is the part which is now automated by the following ```for``` loop:
```
for i in reversed(sorted(glob.glob("/webserver/images/fulls/*"), key=os.path.getmtime)):
    _media_div = _cont_div.add(div(cls='media all place'))
    _photo = _media_div.add(a(href='%s' % i[14:]))
    _src = _photo.add(img(src=i.replace('fulls' , 'thumbs')[14:],title=os.path.basename(i)[9:-4]))
```
What happens here is that the script looks at all photos in the ```fulls``` directory on my web server and creates for each image the required ```div``` elements. Furthermore, it uses thumbnails for efficiency which are located in the ```thumbs``` directory - the script replaces simply the word ```fulls``` with ```thumbs``` (the filenames are the same).
Finally, it uses the filename of each photo to generate the title (which is displayed when clicking on a thumbnail). All photos have the same filename pattern: ```YYYYMMDD_City, Country.jpg```.
So the title is the filename minus the date and the filename extension: ```City, Country```.

The whole Python script is wrapped by a bash script which moves the images files from the ftp input directory to the web server directory. And that's it folks!

Now, I upload new photos including a custom made thumbnail via ftp to my compute instance and then start my ```update.sh``` script which takes care of the html code updates and that the files are located in the right directory.